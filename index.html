<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree Viewer</title>
  <style>
    body {
      font-family: monospace;
      white-space: pre;
      padding: 20px;
    }
  </style>
</head>
<body>

<h1>Family Tree</h1>
<pre id="tree"></pre>

<script>
async function loadGEDCOM() {
  const response = await fetch('family_tree.ged');
  const text = await response.text();
  return text;
}

function parseGEDCOM(text) {
  const lines = text.split('\n').map(line => line.trim());
  const individuals = {};
  const families = {};

  let currentId = null;
  let currentFam = null;

  for (const line of lines) {
    const indiMatch = line.match(/^0\s+(@I\d+@)\s+INDI/);
    const famMatch = line.match(/^0\s+(@F\d+@)\s+FAM/);

    if (indiMatch) {
      currentId = indiMatch[1];
    } else if (famMatch) {
      currentFam = famMatch[1];
    } else if (line.startsWith('1 NAME') && currentId) {
      let name = line.substring(7).replace(/\//g, '').trim();
      if (name.length > 15) name = name.substring(0, 14) + 'â€¦';
      individuals[currentId] = { name, parents: [], children: [] };
    } else if (line.startsWith('1 FAMC') && currentId) {
      const famc = line.split(' ').pop();
      individuals[currentId].parents.push(famc);
    } else if (line.startsWith('1 FAMS') && currentId) {
      const fams = line.split(' ').pop();
      individuals[currentId].families = individuals[currentId].families || [];
      individuals[currentId].families.push(fams);
    } else if (line.startsWith('1 HUSB') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].husb = line.split(' ').pop();
    } else if (line.startsWith('1 WIFE') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].wife = line.split(' ').pop();
    } else if (line.startsWith('1 CHIL') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].chil = families[currentFam].chil || [];
      families[currentFam].chil.push(line.split(' ').pop());
    }
  }

  // Link parents and children
  for (const famId in families) {
    const fam = families[famId];
    const { husb, wife, chil = [] } = fam;
    for (const childId of chil) {
      if (individuals[childId]) {
        individuals[childId].father = husb;
        individuals[childId].mother = wife;
      }
      if (individuals[husb]) individuals[husb].children.push(childId);
      if (individuals[wife]) individuals[wife].children.push(childId);
    }
  }

  return { individuals, families };
}

function generateTree(individuals, families) {
  const getName = id => individuals[id] ? individuals[id].name : '?';

  const husband1 = getName(families["@F0002@"].husb);
  const wife1 = getName(families["@F0002@"].wife);
  const husband2 = getName(families["@F0001@"].husb);
  const wife2 = getName(families["@F0001@"].wife);

  const father = getName(families["@F0000@"].husb);
  const mother = getName(families["@F0000@"].wife);

  const children = (families["@F0000@"].chil || []).map(getName);

  let tree = "";
  tree += `${husband1} +++ ${wife1}`.padEnd(50) + `${husband2} +++ ${wife2}\n`;
  tree += " ".repeat(20) + "\\".padEnd(30) + "/\n";
  tree += " ".repeat(26) + `${father} +++ ${mother}\n`;
  tree += " ".repeat(30) + "|\n";
  tree += " ".repeat(10) + "-".repeat(45) + "\n";
  tree += " ".repeat(10) + children.join(" | ") + "\n";

  return tree;
}

async function main() {
  const gedcom = await loadGEDCOM();
  const { individuals, families } = await parseGEDCOM(gedcom);
  const tree = generateTree(individuals, families);
  document.getElementById('tree').textContent = tree;
}

main();
</script>

</body>
</html>
