<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Family Tree Viewer</title>
  <style>
    body {
      font-family: monospace;
      white-space: pre;
      padding: 20px;
    }
  </style>
</head>
<body>

<h1>Family Tree</h1>
<pre id="tree"></pre>

<script>
async function loadGEDCOM() {
  const response = await fetch('family_tree.ged');
  const text = await response.text();
  return text;
}

function parseGEDCOM(text) {
  const lines = text.split('\n').map(line => line.trim());
  const individuals = {};
  const families = {};

  let currentId = null;
  let currentFam = null;

  for (const line of lines) {
    const indiMatch = line.match(/^0\s+(@I\d+@)\s+INDI/);
    const famMatch = line.match(/^0\s+(@F\d+@)\s+FAM/);

    if (indiMatch) {
      currentId = indiMatch[1];
    } else if (famMatch) {
      currentFam = famMatch[1];
    } else if (line.startsWith('1 NAME') && currentId) {
      let name = line.substring(7).replace(/\//g, '').trim();
      if (name.length > 15) name = name.substring(0, 14) + 'â€¦';
      individuals[currentId] = { name, parents: [], children: [] };
    } else if (line.startsWith('1 FAMC') && currentId) {
      const famc = line.split(' ').pop();
      individuals[currentId].parents.push(famc);
    } else if (line.startsWith('1 FAMS') && currentId) {
      const fams = line.split(' ').pop();
      individuals[currentId].families = individuals[currentId].families || [];
      individuals[currentId].families.push(fams);
    } else if (line.startsWith('1 HUSB') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].husb = line.split(' ').pop();
    } else if (line.startsWith('1 WIFE') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].wife = line.split(' ').pop();
    } else if (line.startsWith('1 CHIL') && currentFam) {
      families[currentFam] = families[currentFam] || {};
      families[currentFam].chil = families[currentFam].chil || [];
      families[currentFam].chil.push(line.split(' ').pop());
    }
  }

  // Link parents and children
  for (const famId in families) {
    const fam = families[famId];
    const { husb, wife, chil = [] } = fam;
    for (const childId of chil) {
      if (individuals[childId]) {
        individuals[childId].father = husb;
        individuals[childId].mother = wife;
      }
      if (individuals[husb]) individuals[husb].children.push(childId);
      if (individuals[wife]) individuals[wife].children.push(childId);
    }
  }

  return { individuals, families };
}

function getName(individuals, id) {
  return individuals[id] ? individuals[id].name : '?';
}

// Walk up the tree recursively
function buildTree(individuals, startIds, level = 0) {
  let output = "";
  let nextLevel = [];

  for (let id of startIds) {
    const indi = individuals[id];
    if (!indi) continue;

    // Print parents if they exist
    const famc = indi.parents[0];
    if (famc && families[famc]) {
      const fatherId = families[famc].husb;
      const motherId = families[famc].wife;
      if (fatherId && motherId) {
        output += " ".repeat(level * 4) + getName(individuals, fatherId) + " +++ " + getName(individuals, motherId) + "\n";
        nextLevel.push(fatherId, motherId);
      }
    }
  }

  if (nextLevel.length > 0) {
    output += buildTree(individuals, nextLevel, level + 1);
  }

  return output;
}

async function main() {
  const gedcom = await loadGEDCOM();
  const { individuals, families: fams } = await parseGEDCOM(gedcom);
  window.families = fams; // so buildTree can access it

  // Start from Braden Jonsson
  const startId = Object.keys(individuals).find(id => individuals[id].name.startsWith("Braden"));
  const tree = buildTree(individuals, [startId]);

  document.getElementById('tree').textContent = tree;
}

main();
</script>

</body>
</html>
